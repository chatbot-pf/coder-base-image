# Dev Container Features Tests

Tests for devcontainer features following the official [feature-starter](https://github.com/devcontainers/feature-starter) template.

## Test Structure

```
test/
├── _global/                    # Global scenarios testing multiple features
│   ├── scenarios.json          # Multi-feature test scenarios
│   ├── full_stack_dev.sh       # Full-stack development test
│   └── complete_environment.sh # All features integration test
├── shell-utils/
│   ├── test.sh                 # Basic test
│   └── scenarios.json          # Feature-specific scenarios
├── node/
│   ├── test.sh
│   └── scenarios.json
└── ...
```

## Running Tests

### Using devcontainer CLI (Recommended)

```bash
# Install devcontainer CLI
npm install -g @devcontainers/cli

# Test all features with auto-generated configs
devcontainer features test .

# Test specific feature
devcontainer features test -f shell-utils .

# Test specific feature against specific base image
devcontainer features test -f node -i ubuntu:22.04 .

# Test only scenarios (skip auto-generated)
devcontainer features test --skip-autogenerated .

# Test only global scenarios
devcontainer features test --global-scenarios-only .
```

### Manual Testing

```bash
# Build and test in one command
devcontainer features test -f node .
```

## Test Types

### 1. Auto-generated Tests
Basic tests run against default feature options on multiple base images:
- `debian:latest`
- `ubuntu:latest`
- `mcr.microsoft.com/devcontainers/base:ubuntu`

### 2. Scenario Tests
Feature-specific scenarios defined in `scenarios.json`:
- Different option combinations
- Edge cases
- Integration scenarios

### 3. Global Scenarios
Multi-feature integration tests in `_global/scenarios.json`:
- `full_stack_dev`: Node.js + Bun + Deno + Homebrew
- `jvm_development`: Node.js + SDKMAN
- `minimal_javascript`: Shell + Node.js + Bun
- `complete_environment`: All features together

## Writing Tests

### Basic Test (`test.sh`)

```bash
#!/bin/bash
set -e

# Import test library
source dev-container-features-test-lib

# Run checks
check "command exists" command -v mycommand
check "version check" mycommand --version

# Report results
reportResults
```

### Scenarios (`scenarios.json`)

```json
{
    "scenario_name": {
        "image": "ubuntu:22.04",
        "features": {
            "my-feature": {
                "option1": "value1",
                "option2": true
            }
        }
    }
}
```

### Global Scenarios (`_global/scenarios.json`)

```json
{
    "multi_feature_test": {
        "image": "ubuntu:22.04",
        "features": {
            "feature1": {},
            "feature2": {
                "option": "value"
            }
        }
    }
}
```

## CI/CD Integration

Tests run automatically via GitHub Actions:

### `.github/workflows/test.yaml`
- Runs on push to main, PRs, and manual triggers
- Tests all features against multiple base images
- Runs feature-specific scenarios
- Runs global integration tests

### `.github/workflows/validate.yml`
- Validates feature metadata
- Checks JSON syntax
- Verifies install scripts are executable
- Ensures test coverage

## Test Coverage

Current coverage:
- ✅ shell-utils (3 scenarios)
- ✅ node (3 scenarios)
- ✅ homebrew (auto-generated)
- ✅ graphite (auto-generated)
- ✅ bun (auto-generated)
- ✅ deno (auto-generated)
- ✅ sdkman (auto-generated)
- ✅ claude-code (auto-generated)
- ✅ fvm (auto-generated)
- ✅ Global scenarios (4 scenarios)

## Debugging

```bash
# Run with verbose output
devcontainer features test -f node . --log-level trace

# Keep container after test for debugging
devcontainer features test -f node . --skip-cleanup

# Test single scenario
devcontainer features test -f node --scenario with_lts .
```

## Local Development

```bash
# Make changes to feature
vim src/node/install.sh

# Test changes
devcontainer features test -f node .

# Test specific scenario
devcontainer features test -f node --scenario with_version_22 .
```
